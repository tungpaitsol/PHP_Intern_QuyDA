<?php


$listMemberFullTime = array(
    array(
        'code' => '001',
        'full_name' => 'Nguyen Van A',
        'age' => 25,
        'gender' => 0,
        'marital_status' => 0,
        'total_work_time' => 0,
        'salary' => 15000000,
        'workdays' => 0,
        'start_work_time' => '08:00:00',
        'work_hour' => 8,
        'has_lunch_break' => 1
    ),
    array(
        'code' => '002',
        'full_name' => 'Nguyen Thi B',
        'age' => 30,
        'gender' => 1,
        'marital_status' => 1,
        'total_work_time' => 0,
        'salary' => 10000000,
        'workdays' => 0,
        'start_work_time' => '08:30:00',
        'work_hour' => 8,
        'has_lunch_break' => 1
    ),
    array(
        'code' => '003',
        'full_name' => 'Nguyen Van C',
        'age' => 28,
        'gender' => 0,
        'marital_status' => 1,
        'total_work_time' => 0,
        'salary' => 20000000,
        'workdays' => 0,
        'start_work_time' => '09:00:00',
        'work_hour' => 8,
        'has_lunch_break' => 1
    )
);

$listMemberPartTime = array(
    array(
        'code' => '004',
        'full_name' => 'Nguyen Xuan P',
        'age' => 22,
        'gender' => 0,
        'marital_status' => 0,
        'total_work_time' => 0,
        'salary' => 4000000,
        'workdays' => 0,
        'start_work_time' => '09:00:00',
        'work_hour' => 4,
        'has_lunch_break' => 0
    ),
    array(
        'code' => '005',
        'full_name' => 'Nguyen Ngoc T',
        'age' => 21,
        'gender' => 1,
        'marital_status' => 0,
        'total_work_time' => 0,
        'salary' => 3500000,
        'workdays' => 0,
        'start_work_time' => '08:30:00',
        'work_hour' => 3,
        'has_lunch_break' => 1
    )
);

$listWorkTime = array(
    array(
        'member_code' => '001',
        'start_datetime' => '2019-04-01 08:00:00',
        'end_datetime' => '2019-04-01 19:00:00'
    ),

    array(
        'member_code' => '001',
        'start_datetime' => '2019-05-02 08:10:00',
        'end_datetime' => '2019-05-02 17:00:00'
    ),
    array(
        'member_code' => '001',
        'start_datetime' => '2019-04-03 08:50:00',
        'end_datetime' => '2019-04-03 18:00:00'
    ),
    array(
        'member_code' => '001',
        'start_datetime' => '2019-04-04 08:20:00',
        'end_datetime' => '2019-04-04 18:20:00'
    ),
    array(
        'member_code' => '001',
        'start_datetime' => '2019-04-05 09:02:00',
        'end_datetime' => '2019-04-05 17:40:00'
    ),
    array(
        'member_code' => '001',
        'start_datetime' => '2019-04-06 08:20:00',
        'end_datetime' => '2019-04-06 18:30:00'
    ),
    array(
        'member_code' => '002',
        'start_datetime' => '2019-04-01 08:00:00',
        'end_datetime' => '2019-04-01 19:00:00'
    ),
    array(
        'member_code' => '002',
        'start_datetime' => '2019-05-02 08:10:00',
        'end_datetime' => '2019-05-02 17:00:00'
    ),
    array(
        'member_code' => '002',
        'start_datetime' => '2019-04-03 08:50:00',
        'end_datetime' => '2019-04-03 18:00:00'
    ),
    array(
        'member_code' => '002',
        'start_datetime' => '2019-04-04 08:20:00',
        'end_datetime' => '2019-04-04 18:20:00'
    ),
    array(
        'member_code' => '002',
        'start_datetime' => '2019-04-05 09:02:00',
        'end_datetime' => '2019-04-05 17:40:00'
    ),
    array(
        'member_code' => '002',
        'start_datetime' => '2019-04-06 08:20:00',
        'end_datetime' => '2019-04-06 18:30:00'
    ),

    array(
        'member_code' => '003',
        'start_datetime' => '2019-04-01 08:00:00',
        'end_datetime' => '2019-04-01 19:00:00'
    ),
    array(
        'member_code' => '003',
        'start_datetime' => '2019-04-02 08:10:00',
        'end_datetime' => '2019-04-02 17:00:00'
    ),
    array(
        'member_code' => '003',
        'start_datetime' => '2019-04-03 08:50:00',
        'end_datetime' => '2019-04-03 18:00:00'
    ),
    array(
        'member_code' => '003',
        'start_datetime' => '2019-04-04 08:20:00',
        'end_datetime' => '2019-04-04 18:20:00'
    ),
    array(
        'member_code' => '003',
        'start_datetime' => '2019-05-05 09:02:00',
        'end_datetime' => '2019-05-05 17:40:00'
    ),
    array(
        'member_code' => '003',
        'start_datetime' => '2019-03-06 08:20:00',
        'end_datetime' => '2019-03-06 18:30:00'
    ),


    array(
        'member_code' => '004',
        'start_datetime' => '2019-04-01 08:00:00',
        'end_datetime' => '2019-04-01 12:00:00'
    ),
    array(
        'member_code' => '004',
        'start_datetime' => '2019-04-02 08:10:00',
        'end_datetime' => '2019-04-02 11:30:00'
    ),
    array(
        'member_code' => '004',
        'start_datetime' => '2019-04-03 08:50:00',
        'end_datetime' => '2019-04-03 11:40:00'
    ),
    array(
        'member_code' => '004',
        'start_datetime' => '2019-04-04 08:20:00',
        'end_datetime' => '2019-04-04 12:10:00'
    ),
    array(
        'member_code' => '004',
        'start_datetime' => '2019-04-05 09:02:00',
        'end_datetime' => '2019-04-05 11:45:00'
    ),
    array(
        'member_code' => '004',
        'start_datetime' => '2019-04-06 08:20:00',
        'end_datetime' => '2019-04-06 12:30:00'
    ),

    array(
        'member_code' => '005',
        'start_datetime' => '2019-04-01 08:00:00',
        'end_datetime' => '2019-04-01 12:00:00'
    ),
    array(
        'member_code' => '005',
        'start_datetime' => '2019-04-02 08:10:00',
        'end_datetime' => '2019-04-02 11:30:00'
    ),
    array(
        'member_code' => '005',
        'start_datetime' => '2019-04-03 08:50:00',
        'end_datetime' => '2019-04-03 11:40:00'
    ),
    array(
        'member_code' => '005',
        'start_datetime' => '2019-08-04 08:20:00',
        'end_datetime' => '2019-08-04 12:10:00'
    ),
    array(
        'member_code' => '005',
        'start_datetime' => '2019-04-05 09:02:00',
        'end_datetime' => '2019-04-05 11:45:00'
    ),
    array(
        'member_code' => '005',
        'start_datetime' => '2019-04-06 08:20:00',
        'end_datetime' => '2019-04-06 12:30:00'
    ),

);

//function getWorkingDays($startDate,$endDate,$holidays){
//    $endDate = strtotime($endDate);
//    $startDate = strtotime($startDate);
//
//    $days = ($endDate - $startDate) / 86400 + 1;
//
//    $no_full_weeks = floor($days / 7);
//    $no_remaining_days = fmod($days, 7);
//
//    $the_first_day_of_week = date("N", $startDate);
//    $the_last_day_of_week = date("N", $endDate);
//
//    if ($the_first_day_of_week <= $the_last_day_of_week) {
//        if ($the_first_day_of_week <= 6 && 6 <= $the_last_day_of_week) $no_remaining_days--;
//        if ($the_first_day_of_week <= 7 && 7 <= $the_last_day_of_week) $no_remaining_days--;
//    }
//    else {
//
//        if ($the_first_day_of_week == 7) {
//            $no_remaining_days--;
//
//            if ($the_last_day_of_week == 6) {
//                $no_remaining_days--;
//            }
//        }
//        else {
//
//            $no_remaining_days -= 2;
//        }
//    }
//    $workingDays = $no_full_weeks * 5;
//    if ($no_remaining_days > 0 )
//    {
//        $workingDays += $no_remaining_days;
//    }
//
//
//    foreach($holidays as $holiday){
//        $time_stamp=strtotime($holiday);
//
//        if ($startDate <= $time_stamp && $time_stamp <= $endDate && date("N",$time_stamp) != 6 && date("N",$time_stamp) != 7)
//            $workingDays--;
//    }
//
//    return $workingDays;
//}
//
//$holidays=["2019-01-01","2019-02-04","2019-02-05","2019-02-06","2019-02-07","2019-02-08","2019-04-14","2019-04-30","2019-05-01","2019-09-02"];
//
//$workday1 = getWorkingDays("2019-01-01","2019-01-31", $holidays);
//$workday2 = getWorkingDays("2019-02-01","2019-02-28", $holidays);
//$workday3 = getWorkingDays("2019-03-01","2019-03-31", $holidays);
//$workday4 = getWorkingDays("2019-04-01","2019-04-30", $holidays);
//$workday5 = getWorkingDays("2019-05-01","2019-05-31", $holidays);
//$workday6 = getWorkingDays("2019-06-01","2019-06-30", $holidays);
//$workday7 = getWorkingDays("2019-07-01","2019-07-31", $holidays);
//$workday8 = getWorkingDays("2019-08-01","2019-08-31", $holidays);
//$workday9 = getWorkingDays("2019-09-01","2019-09-30", $holidays);
//$workday10 = getWorkingDays("2019-10-01","2019-10-31", $holidays);
//$workday11 = getWorkingDays("2019-11-01","2019-11-30", $holidays);
//$workday12 = getWorkingDays("2019-12-01","2019-12-31", $holidays);

function getWorkingDays($start, $end)
{
    $end->modify('+1 day');

    $interval = $end->diff($start);

    $days = $interval->days;

    $period = new DatePeriod($start, new DateInterval('P1D'), $end);

    $holidays = ["2019-01-01", "2019-02-04", "2019-02-05", "2019-02-06", "2019-02-07", "2019-02-08", "2019-04-14", "2019-04-30", "2019-05-01", "2019-09-02"];

    foreach ($period as $dt) {
        $curr = $dt->format('D');

        if ($curr == 'Sat' || $curr == 'Sun') {
            $days--;
        }

        if (in_array($dt->format('Y-m-d'), $holidays)) {
            $days--;
        }
    }

    return $days;
}

$workday1 = getWorkingDays(new DateTime('2019-01-01'), new DateTime('2019-01-31'));
$workday2 = getWorkingDays(new DateTime('2019-02-01'), new DateTime('2019-02-28'));
$workday3 = getWorkingDays(new DateTime('2019-03-01'), new DateTime('2019-03-31'));
$workday4 = getWorkingDays(new DateTime('2019-04-01'), new DateTime('2019-04-30'));
$workday5 = getWorkingDays(new DateTime('2019-05-01'), new DateTime('2019-05-31'));
$workday6 = getWorkingDays(new DateTime('2019-06-01'), new DateTime('2019-06-30'));
$workday7 = getWorkingDays(new DateTime('2019-07-01'), new DateTime('2019-07-31'));
$workday8 = getWorkingDays(new DateTime('2019-08-01'), new DateTime('2019-08-31'));
$workday9 = getWorkingDays(new DateTime('2019-09-01'), new DateTime('2019-09-30'));
$workday10 = getWorkingDays(new DateTime('2019-10-01'), new DateTime('2019-10-31'));
$workday11 = getWorkingDays(new DateTime('2019-11-01'), new DateTime('2019-11-30'));
$workday12 = getWorkingDays(new DateTime('2019-12-01'), new DateTime('2019-12-31'));


$list = [[], [], [], [], [], [], [], [], [], [], [], []];

foreach ($listWorkTime as $item) {
    $date = getdate(strtotime($item['start_datetime']));
//    if ($date['mon'] == 1) {
//        array_push($list[0], $item);
//    }
//    if ($date['mon'] == 2) {
//        array_push($list[1], $item);
//    }
//    if ($date['mon'] == 3) {
//        array_push($list[2], $item);
//    }
//    if ($date['mon'] == 4) {
//        array_push($list[3], $item);
//    }
//    if ($date['mon'] == 5) {
//        array_push($list[4], $item);
//    }
//    if ($date['mon'] == 6) {
//        array_push($list[5], $item);
//    }
//    if ($date['mon'] == 7) {
//        array_push($list[6], $item);
//    }
//    if ($date['mon'] == 8) {
//        array_push($list[7], $item);
//    }
//    if ($date['mon'] == 9) {
//        array_push($list[8], $item);
//    }
//    if ($date['mon'] == 10) {
//        array_push($list[9], $item);
//    }
//    if ($date['mon'] == 11) {
//        array_push($list[10], $item);
//    }
//    if ($date['mon'] == 12) {
//        array_push($list[11], $item);
//    }
    for ($i = 1; $i <= count($list); $i++) {
        if ($date['mon'] == $i) {
            array_push($list[$i - 1], $item);
        }
    }

}


$workdays = [];
foreach ($listMemberPartTime as $v) {
    $count = 0;
    foreach ($listWorkTime as $value) {
        if ($v['code'] == $value['member_code']) {
            if (((strtotime($value['end_datetime']) - strtotime($value['start_datetime'])) / 3600) >= $v['work_hour']) {
                $count = $count + 1;
            }
        }
    }
    array_push($workdays, $count);
}
//print_r($workdays);

for ($i = 0; $i < count($listMemberPartTime); $i++) {
    $listMemberPartTime[$i]['workdays'] = $workdays[$i];
}

$arrayAllMonth = [];
foreach ($list as $month) {
    $people = [];
    foreach ($listMemberPartTime as $member) {
        $count = 0;
        foreach ($month as $array) {
            if ($array['member_code'] == $member['code']) {
                if (((strtotime($array['end_datetime']) - strtotime($array['start_datetime'])) / 3600) >= $member['work_hour']) {
                    $count = $count + 1;
                }

                $people[(int)$member['code']] = $count;
            }
        }

    }
    $arrayAllMonth[] = $people;
}


$month1 = $arrayAllMonth[0];
$month2 = $arrayAllMonth[1];
$month3 = $arrayAllMonth[2];
$month4 = $arrayAllMonth[3];
$month5 = $arrayAllMonth[4];
$month6 = $arrayAllMonth[5];
$month7 = $arrayAllMonth[6];
$month8 = $arrayAllMonth[7];
$month9 = $arrayAllMonth[8];
$month10 = $arrayAllMonth[9];
$month11 = $arrayAllMonth[10];
$month12 = $arrayAllMonth[11];

print_r($arrayAllMonth);

$money = [];

for ($k = 0; $k < count($listMemberPartTime); $k++) {

    if (!isset($month1[(int)$listMemberPartTime[$k]['code']])) {
        $month1[(int)$listMemberPartTime[$k]['code']] = 0;
    }
    if (!isset($month2[(int)$listMemberPartTime[$k]['code']])) {
        $month2[(int)$listMemberPartTime[$k]['code']] = 0;
    }
    if (!isset($month3[(int)$listMemberPartTime[$k]['code']])) {
        $month3[(int)$listMemberPartTime[$k]['code']] = 0;
    }
    if (!isset($month4[(int)$listMemberPartTime[$k]['code']])) {
        $month4[(int)$listMemberPartTime[$k]['code']] = 0;
    }
    if (!isset($month5[(int)$listMemberPartTime[$k]['code']])) {
        $month5[(int)$listMemberPartTime[$k]['code']] = 0;
    }
    if (!isset($month6[(int)$listMemberPartTime[$k]['code']])) {
        $month6[(int)$listMemberPartTime[$k]['code']] = 0;
    }
    if (!isset($month7[(int)$listMemberPartTime[$k]['code']])) {
        $month7[(int)$listMemberPartTime[$k]['code']] = 0;
    }
    if (!isset($month8[(int)$listMemberPartTime[$k]['code']])) {
        $month8[(int)$listMemberPartTime[$k]['code']] = 0;
    }
    if (!isset($month9[(int)$listMemberPartTime[$k]['code']])) {
        $month9[(int)$listMemberPartTime[$k]['code']] = 0;
    }
    if (!isset($month10[(int)$listMemberPartTime[$k]['code']])) {
        $month10[(int)$listMemberPartTime[$k]['code']] = 0;
    }
    if (!isset($month11[(int)$listMemberPartTime[$k]['code']])) {
        $month11[(int)$listMemberPartTime[$k]['code']] = 0;
    }
    if (!isset($month12[(int)$listMemberPartTime[$k]['code']])) {
        $month12[(int)$listMemberPartTime[$k]['code']] = 0;
    }

    $real_money =
        $listMemberPartTime[$k]['salary'] / $workday1 * $month1[(int)$listMemberPartTime[$k]['code']]
        + $listMemberPartTime[$k]['salary'] / $workday2 * $month2[(int)$listMemberPartTime[$k]['code']]
        + $listMemberPartTime[$k]['salary'] / $workday3 * $month3[(int)$listMemberPartTime[$k]['code']]
        + $listMemberPartTime[$k]['salary'] / $workday4 * $month4[(int)$listMemberPartTime[$k]['code']]
        + $listMemberPartTime[$k]['salary'] / $workday5 * $month5[(int)$listMemberPartTime[$k]['code']]
        + $listMemberPartTime[$k]['salary'] / $workday6 * $month6[(int)$listMemberPartTime[$k]['code']]
        + $listMemberPartTime[$k]['salary'] / $workday7 * $month7[(int)$listMemberPartTime[$k]['code']]
        + $listMemberPartTime[$k]['salary'] / $workday8 * $month8[(int)$listMemberPartTime[$k]['code']]
        + $listMemberPartTime[$k]['salary'] / $workday9 * $month9[(int)$listMemberPartTime[$k]['code']]
        + $listMemberPartTime[$k]['salary'] / $workday10 * $month10[(int)$listMemberPartTime[$k]['code']]
        + $listMemberPartTime[$k]['salary'] / $workday11 * $month11[(int)$listMemberPartTime[$k]['code']]
        + $listMemberPartTime[$k]['salary'] / $workday12 * $month12[(int)$listMemberPartTime[$k]['code']];

    array_push($money, $real_money);
}

for ($i = 0; $i < count($listMemberPartTime); $i++) {
    $listMemberPartTime[$i]['salary'] = $money[$i];
}

echo "<pre>";
print_r($listMemberPartTime);


